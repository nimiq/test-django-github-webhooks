#!/bin/bash

date=`date`
echo " * STARTING a new deployment on $date."

echo " * Waiting 15 seconds to give time to our server to reply to GitHub..."
# This is to give time to the server to reply to GitHub, since the next command
# `sv stop webapp` will stop our webserver.
sleep 15

echo " * Stopping the webapp service..."
sv stop webapp

echo " * Pulling new code..."
git pull

echo " * Migrating the db..."
python manage.py migrate --noinput

echo " * Collecting static files..."
python manage.py collectstatic --noinput

echo " * Starting the webapp service..."
sv start webapp

date=`date`
echo " * END of the deployment on $date."
echo